<script lang="ts">
    import { goto } from '$app/navigation';

    import Button from '$components/Button.svelte';
    import ButtonToggle from '$components/ButtonToggle.svelte';
    import Flex from '$components/Flex.svelte';
    import Section from '$components/Forms/LabeledSection.svelte';
    import Input from '$components/Input.svelte';
    import McpServerList from '$components/Mcp/ServerList.svelte';
    import ModelSelect from '$components/ModelSelect.svelte';
    import Select from '$components/Select.svelte';
    import Svg from '$components/Svg.svelte';
    import Textarea from '$components/Textarea.svelte';
    import { App, AppStep, McpServer, Model, Trigger } from '$lib/models';
    import type { FilesystemConfig, ScheduledConfig } from '$lib/models/trigger.svelte';

    interface Props {
        app: App;
    }

    let { app }: Props = $props();

    // Steps
    let steps: AppStep[] = $state(app.steps);

    // MCP Servers
    let mcpServers: McpServer[] = $state(app.mcpServers.compact());

    // Model
    let model: Model = $state(app.steps[0]?.model || Model.default());

    // Copied instances of all base MCP servers.
    let mcpServerCopies = $state(copyMcpServers());

    // Trigger
    let trigger: Trigger = $state(app.trigger);
    let interval: 'hourly' | 'daily' = $state('hourly');
    let hour = $state('0 12 * * *');
    let action: Trigger['action'] = $state('tick');

    let filesystemConfig: FilesystemConfig = $state({ path: '' });
    let scheduledConfig: ScheduledConfig = $state({ period: '0 * * * *' });

    const hourOptions = Array.from({ length: 24 }, (_, i) => {
        const hour = i % 12 === 0 ? 12 : i % 12;
        const ampm = i < 12 ? 'AM' : 'PM';
        return { label: `${hour}:00 ${ampm}`, value: `0 ${i} * * *` };
    });

    function copyMcpServers() {
        return McpServer.forChat().map(server => {
            return (
                mcpServers.find(s => s.name == server.name) ??
                McpServer.new({
                    name: server.name,
                    command: server.command,
                    args: server.args,
                    env: server.env,
                })
            );
        });
    }

    async function setModel(_model: Model) {
        model = _model;
    }

    function setInterval(interval: string) {
        scheduledConfig.period = interval == 'hourly' ? '0 * * * *' : hour;
        setConfig();
    }

    function setEvent(event: Trigger['event']) {
        trigger.event = event;
        trigger.action = event == 'scheduled' ? 'tick' : action;
        setConfig();
    }

    function setAction(action: Trigger['action']) {
        trigger.action = action;
        setConfig();
    }

    function setPeriod(period: string) {
        scheduledConfig.period = period;
        setConfig();
    }

    function setConfig() {
        trigger.config = trigger.event == 'scheduled' ? scheduledConfig : filesystemConfig;
    }

    function addStep() {
        steps.push(AppStep.new({ appId: app.id }));
    }

    function removeStep(step: AppStep) {
        steps = steps.filter(s => s !== step);
    }

    function hasMcpServer(server: McpServer) {
        return mcpServers.includes(server);
    }

    function addMcpServer(server: McpServer) {
        mcpServers.push(server);
    }

    function removeMcpServer(server: McpServer) {
        mcpServers = mcpServers.filter(s => s !== server);
    }

    async function save() {
        app = await app.save();

        trigger.appId = app.id;
        await trigger.save();

        await steps.awaitAll(async step => {
            step.appId = app.id;
            step.engineId = model.engineId as number;
            step.modelId = model.id as string;
            await step.save();
        });

        await app.mcpServers.awaitAll(async server => {
            if (!mcpServers.mapBy('name').includes(server.name)) {
                if (server.id) {
                    await app.removeMcpServer(server);
                    await server.delete();
                }
            }
        });

        await mcpServers.awaitAll(async server => {
            const mcp = await server.save();

            // Ensure the instance in `mcpServers` is updated to match to
            // persisted one in the database, so that subsequent saves act on
            // the correct record.
            server.id = mcp.id;
            server.metadata = mcp.metadata;

            await app.addMcpServer(mcp);
        });

        // Reset MCP servers to match the new state of the world after we
        // reconcile them above.
        mcpServers = app.mcpServers.compact();
        mcpServerCopies = copyMcpServers();

        await goto(`/apps/${app.id}/edit`);
    }
</script>

<section class="w-full overflow-y-auto p-8">
    <Flex class="border-light text-medium w-full flex-col items-start rounded-md border">
        <Section icon="Apps" title="Name" tooltip="The name of the App" class="items-center">
            <Input
                label={false}
                name="name"
                placeholder="Name of the app"
                class="text-light px-4 py-1 outline-0"
                bind:value={app.name}
            />
        </Section>

        <Section
            icon="Trigger"
            title="Trigger"
            tooltip="What triggers the App to execute"
            class="items-center"
        >
            <Button
                onclick={() => setEvent('scheduled')}
                class={`border-light mr-4 ${
                    trigger.event == 'scheduled' ? 'text-light bg-light font-medium' : ''
                }`}
            >
                Scheduled
            </Button>

            <Button
                onclick={() => setEvent('filesystem')}
                class={`border-light mr-4 ${trigger.event == 'filesystem' ? 'text-light' : ''}`}
            >
                Filesystem
            </Button>
        </Section>

        {#if trigger.event == 'scheduled'}
            <Section
                icon="Tasks"
                title="Interval"
                tooltip="How often should the App execute"
                class="h-20 items-center"
            >
                <ButtonToggle
                    onchange={setInterval}
                    values={['hourly', 'daily']}
                    bind:value={interval}
                    class="h-full"
                />

                {#if interval == 'daily'}
                    <p class="mx-4">at</p>

                    <div class="w-56">
                        <!-- prettier-ignore -->
                        <Select
                            onselect={() => setPeriod(hour)}
                            class="z-50"
                            options={hourOptions}
                            bind:value={hour}
                        />
                    </div>
                {/if}
            </Section>
        {:else if trigger.event == 'filesystem'}
            <Section
                icon="Folders"
                title="Directory"
                tooltip="The directory Tome will monitor for file events. Must be an absolute path."
            >
                <Flex class="border-b-light grow flex-col items-start">
                    <!-- prettier-ignore -->
                    <input
                        class="text-light mb-4 grow font-mono outline-0"
                        placeholder="/path/to/watch-for-changes"
                        type="text"
                        bind:value={filesystemConfig.path}
                    />

                    <Flex class="gap-4">
                        <Flex>
                            <input
                                onclick={() => setAction('created')}
                                bind:group={action}
                                class="text-medium"
                                id="created"
                                value="created"
                                type="radio"
                            />
                            <label class="ml-2" for="created">File Created</label>
                        </Flex>

                        <Flex>
                            <input
                                onclick={() => setAction('updated')}
                                bind:group={action}
                                id="updated"
                                value="updated"
                                type="radio"
                            />
                            <label class="ml-2" for="updated">File Updated</label>
                        </Flex>

                        <Flex>
                            <input
                                onclick={() => setAction('deleted')}
                                bind:group={action}
                                id="deleted"
                                value="deleted"
                                type="radio"
                            />
                            <label class="ml-2" for="deleted">File Deleted</label>
                        </Flex>
                    </Flex>
                </Flex>
            </Section>
        {/if}

        <Section icon="Models" title="Model" tooltip="The LLM the App should use">
            <ModelSelect selected={model} onselect={setModel} class="h-10" />
        </Section>

        <Section
            icon="Chat"
            title="Prompts"
            tooltip="Prompts are passed to the LLM, in order. History is maintained and passed each time."
        >
            <Flex class="grow flex-col items-start">
                {#each steps as step, i (i)}
                    <Flex
                        class="border-light relative mb-8 w-full flex-col items-start rounded-md border"
                    >
                        <Flex class="border-b-light w-full items-center justify-end border-b">
                            <Button
                                onclick={() => removeStep(step)}
                                class="border-l-light hover:text-red h-8 border-0
                                border-l px-3 transition-colors"
                            >
                                <Svg name="X" class="h-2 w-2" />
                            </Button>
                        </Flex>

                        <Textarea
                            label={false}
                            bind:value={step.prompt}
                            placeholder="Add a prompt"
                            class="text-light bg-medium border-0 p-2 px-4"
                        />

                        <button
                            onclick={addStep}
                            class={`border-light bg-medium text-medium absolute
                            -bottom-4 left-[calc(50%-96px)] flex h-8 w-8
                            flex-col content-center items-center rounded-full
                            border font-mono leading-7.5 font-bold hover:cursor-pointer
                            ${i !== steps.length - 1 ? 'hidden' : ''}`}
                        >
                            +
                        </button>

                        {#if i !== steps.length - 1}
                            <div
                                class="bg-light absolute -bottom-8 left-[calc(50%-83px)] h-8 w-[2px]"
                            ></div>
                        {/if}
                    </Flex>
                {/each}
            </Flex>
        </Section>

        <Section
            icon="MCP"
            title="MCP"
            tooltip="The collection of MCP servers to enable when this App executes"
        >
            <Flex class="grow">
                <McpServerList
                    servers={mcpServerCopies}
                    enabled={hasMcpServer}
                    onadd={addMcpServer}
                    onremove={removeMcpServer}
                />
            </Flex>
        </Section>
    </Flex>

    <div class="mt-8">
        <Button class="text-purple border-purple" onclick={save}>Save</Button>
    </div>
</section>
